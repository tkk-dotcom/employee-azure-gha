name: Build and Deploy Employee App to AKS

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: employee-rg
  AKS_CLUSTER: employee-aks
  ACR_NAME: employeeacr
  HELM_CHART_PATH: ./helm/employee-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Azure using OIDC
        uses: azure/login@v2
        with:
          client-id: 5a98946b-1cfc-41eb-872b-7e68ed7f3c81
          tenant-id: a11c3d03-37d6-45fa-992d-bbd72b17bbcf
          subscription-id: 1569933f-380c-4d4b-9d18-599f50547cb9
          allow-no-subscriptions: true
  
      - name: Create Resource Group
        run: |
          echo "Creating Resource Group if not exists..."
          az group create --name "${{ env.RESOURCE_GROUP }}" --location "eastus"
      
      - name: Create Azure Container Registry if not exists
        run: |
          echo "Checking if ACR exists..."
          if ! az acr show --name "${{ env.ACR_NAME }}" --resource-group "${{ env.RESOURCE_GROUP }}" >/dev/null 2>&1; then
            echo "Creating Azure Container Registry..."
            az acr create \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --name "${{ env.ACR_NAME }}" \
              --sku Basic \
              --admin-enabled true
             echo "acr_exists=false" >> $GITHUB_OUTPUT
           else
             echo "ACR already exists."
             echo "acr_exists=true" >> $GITHUB_OUTPUT
           fi

        # Step 9: Login to ACR
      - name: Login to Azure Container Registry
        run: echo ${{ secrets.ACR_PASSWORD }} | docker login ${{ env.ACR_NAME }}.azurecr.io -u ${{ secrets.ACR_USERNAME }} --password-stdin
      
      - name: Build & Push Backend Image
        run: >
          cd backend

          docker build -t $ACR_NAME.azurecr.io/employee-app-backend:${IMAGE_TAG} .

          docker push $ACR_NAME.azurecr.io/employee-app-backend:${IMAGE_TAG}
      - name: Build & Push Frontend Image
        run: >
          cd frontend

          docker build -t $ACR_NAME.azurecr.io/employee-app-frontend:${IMAGE_TAG} .

          docker push $ACR_NAME.azurecr.io/employee-app-frontend:${IMAGE_TAG}
      - name: Get AKS Credentials
        run: >
          az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER
          --overwrite-existing
      - name: Ensure ingress-nginx exists
        run: >
          set -e

          if ! kubectl get ns ingress-nginx >/dev/null 2>&1; then
            helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
            helm repo update
            helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx               --namespace ingress-nginx --create-namespace
            echo "Waiting for ingress-nginx external IP..."
            kubectl wait --namespace ingress-nginx               --for=condition=available deploy/ingress-nginx-controller --timeout=180s || true
          else
            echo "ingress-nginx already installed."
          fi
      - name: Helm Upgrade/Install
        run: >
          helm upgrade --install employee-app $HELM_CHART_PATH             --set
          backend.image=$ACR_NAME.azurecr.io/employee-app-backend             --set
          backend.tag=${IMAGE_TAG}             --set
          frontend.image=$ACR_NAME.azurecr.io/employee-app-frontend             --set
          frontend.tag=${IMAGE_TAG}
